<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Store test</title>
    <script src="../../theWidgzard.js"></script>
    <style>
    body{font-family:verdana, sans}
    </style>
</head>
<body>
    <div id="trg"></div>
    <script>
        var target = document.getElementById('trg'),
            actions = (function (){
                const initState = {
                    num: 10,
                    name: "Federico",
                    surname: "Ghedina"
                };
                function reducer1(state=initState, actionType, params) {
                    var s = {...state};
                    switch (actionType) {
                        case 'INCREMENT':
                            s.num++;
                            break;
                        case 'DECREMENT':
                            s.num--;
                            break;
                        case 'RESET':
                            return initState;
                            break;
                        case 'RENAME':
                            s.name = params.name;
                            break;
                        default :;
                    }
                    return s;
                }

                var store = Widgzard.getStore(reducer1, initState);

                store.subscribe((oldState, newState, action) => {
                    console.log('----------')
                    console.log(`ACTION dispatched: ${action}`)
                    console.log("previous state: ")
                    console.log(oldState)
                    console.log("new state: ")
                    console.log(newState)
                    console.log("\n\n")
                });
                store.subscribe((oldState, newState) => {
                    Widgzard.Channel('state').pub('dataChanged', newState);
                });

                return {
                    increment: function() {
                        store.dispatch({ type: "INCREMENT" })
                    },
                    decrement: function () {
                        store.dispatch({ type: "DECREMENT" })
                    },
                    reset: function () {
                        store.dispatch({ type: "RESET" })
                    },
                    rename: function (name) {
                        store.dispatch({ type: "RENAME", name: name });
                    },
                    getState: function () {
                        return store.getState();
                    }
                };
            })();

        // now render something
        Widgzard.render({
            target : target,
            data: {
                prova: ''
            },
            content: [{
                tag: 'input',
                attrs: {
                    type: 'text'
                },
                cb: function () {
                    var self = this,
                        $elf = self.node,
                        state = actions.getState();
                    $elf.value = state.name;
                    Widgzard.events.on($elf, 'input', function (e) {
                        actions.rename(e.target.value);
                    })
                    this.done();
                },
                init: function () {
                    var self = this,
                        node = this.node;
                    Widgzard.Channel('state').sub('nameChanged', function (topic, v) {
                        node.value = v;
                    });
                    return true;
                }
            },{
                tag: 'button',
                html: 'decrement',
                onClick: function() {actions.decrement();}
            },{
                tag: 'button',
                html: 'increment',
                onClick: function () { actions.increment(); }
            },{
                tag: 'button',
                html: 'reset',
                onClick: function () { actions.reset(); }
            },{
                tag : 'p',
                init: function() {
                    var node = this.node;
                    Widgzard.Channel('state').sub('numberChanged', function(topic, v) {
                        node.innerHTML = v;
                    });
                    return true;
                },
                cb: function() {
                    var state = actions.getState();
                    this.node.innerHTML = state.num;
                    this.done();
                }
            }],
            cb: function () {
                Widgzard.Channel('state').sub('dataChanged', function(topic, data) {
                    Widgzard.Channel('state').pub('numberChanged', data.num);
                    Widgzard.Channel('state').pub('nameChanged', data.name);
                });
                this.done();
            }
        });
    </script>
    <p>Open the console (ï£¿ + option + i)</p>
</body>
</html>