/*
 _ _ _ _____ ____  _____ _____ _____ _____ ____  
| | | |     |    \|   __|__   |  _  | __  |    \ 
| | | |-   -|  |  |  |  |   __|     |    -|  |  |
|_____|_____|____/|_____|_____|__|__|__|__|____/
												v.0.2
*
* @build 19/7/2017
* @author Federico Ghedina <federico.ghedina@gmail.com>
* Y 2017
* ~17KB
*/
!function(){!function(e){"use strict";function n(e,t,o){e=e.replace(/^\//,"");var r,i=e.split(/\.|\//),c=i.length;return void 0===o&&(o=window),void 0===t&&(t={}),"function"==typeof t&&(t=t()),o[i[0]]||(o[i[0]]=1===c?t:{}),r=o[i[0]],c>1?n(i.slice(1).join("."),t,o[i[0]]):r}function t(e,n){e=e.replace(/^\//,"");var t=e.split(/\.|\//),o=0,r=t.length;if(n=void 0!==n?n:window,!e)return n;for(null;o<r;o+=1){if(void 0===n[t[o]])return;n=n[t[o]]}return n}function o(e,n){var t,o="function"==typeof n?n():n;for(t in o)void 0===e[t]&&(e[t]=o[t])}n("EW",{makeNs:n,checkNs:t,extendNs:o}),n("EW.utils",{uniqueId:new function(){var e=0,n=this;this.prefix="EW_",this.toString=function(){return n.prefix+ ++e}}})}(),EW.makeNs("EW/events"),function(){var e={events:{wwdb_bindings:{},getElementDeterminant:function(e){return e.tagName.match(/input|textarea/i)?"value":"innerHTML"}}};EW.events.on=function(e){return"addEventListener"in e?function(e,n,t){e.addEventListener.apply(e,[n,t,!1])}:"attachEvent"in e?function(e,n,t){e.attachEvent.apply(e,["on"+n,t])}:function(){throw new Error("No straight way to bind an event")}}(this),EW.events.eventTarget=function(e){e=e||window.event;var n=e.currentTarget||void 0!==e.target?e.target:e.srcElement;if(!n)return!1;for(;3===n.nodeType&&null!==n.parentNode;)n=n.parentNode;return n},EW.events.kill=function(e){return e||(e=W.event,e.cancelBubble=!0,e.returnValue=!1),"stopPropagation"in e&&e.stopPropagation()&&e.preventDefault(),!1},EW.events.ready=function(){var e=[],n=setInterval(function(){if("complete"===document.readyState){clearInterval(n);for(var t=0,o=e.length;t<o;t++)e[t].call(this)}},10);return function(n){"complete"===document.readyState?n.call(this):e.push(n)}}(),EW.events.ww={on:function(n,t,o,r){var i=!1,c=!1,a=e.events.getElementDeterminant(o),s=o[a],l=n[t],u=function(e){i=c=!!e};o.wwdbID="_"+EW.util.uniqueid,e.events.wwdb_bindings[o.wwdbID]=window.setInterval(function(){i||(u(!0),l!=n[t]&&(s=n[t],l=s,o[a]=s),u(!1))},25),EW.events.on(o,"keyup",function(){c||(u(!0),this[a]!==n[t]&&(n[t]=this[a],s=this[a],l=this[a]),u(!1))}),o[a]=l},off:function(){for(var n=[].slice.call(arguments,0),t=n.length;t-- >0;)EW.events.off(n[t],"keyup"),window.clearInterval(e.events.wwdb_bindings[n[t].wwdbID])}}}(),EW.makeNs("EW/i18n",function(){var e={};return EW.lang="undefined"!=typeof sm_lang?sm_lang:"en",{load:function(n){e=n},parse:function(e){var n,t,o,r,i=EW.object.digForValue(e,/i18n\(([^}|]*)?\|?([^}]*)\)/);for(o=0,r=i.length;o<r;o++)(typeof i[o].regexp).match(/boolean/i)||(n=EW.i18n.check(i[o].regexp[0]))&&(t=EW.checkNs(i[o].container,e),t[i[o].key]=EW.i18n.get(n[1],n[2]))},dynamicLoad:function(n,t){for(t in n)EW.lang in n[t]&&(e[t]=n[t][EW.lang])},check:function(e){return e.match(/i18n\(([^}|]*)?\|?([^}]*)\)/)},get:function(n,t){return EW.checkNs(n,e)||t||"no Value"}}}),EW.makeNs("EW/io"),EW.io=function(){var e=window,n={getxhr:function(){var n,t=["Msxml2.XMLHTTP","Msxml3.XMLHTTP","Microsoft.XMLHTTP"],o=t.length,r=0;try{n=new e.XMLHttpRequest}catch(i){for(null;r<o;r+=1)try{n=new e.ActiveXObject(t[r])}catch(e){continue}!n&&alert("No way to initialize XHR")}return n},ajcall:function(t,o){var r=n.getxhr(),i=o&&o.method||"POST",c=o&&o.cback,a=o&&o.opened||function(){},s=o&&o.loading||function(){},l=o&&o.error||function(){},u=o&&o.abort||function(){},d=o&&o.async||!0,f=o&&o.data||!1,p=o&&o.type||"text/html",m=!o||void 0===o.cache||o.cache,h="xml"===p?"responseXML":"responseText",g=o&&o.timeout||3e3,v=!1,W=!1,y=!1,b=!1;m||(f.C=+new Date),f=EW.object.toQs(f).substr(1),r.onreadystatechange=function(){var n;if(b===r.readyState)return!1;if(b=r.readyState,"complete"===r.readyState||4===r.readyState&&200===r.status)return v=!0,c&&(W=r[h],function(){c(W)}()),y=r[h],e.setTimeout(function(){r=null},50),y;if(3===r.readyState)s(r);else if(2===r.readyState)a(r);else if(1===r.readyState)switch(i){case"POST":try{r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send(f||!0)}catch(e){}break;case"GET":try{n={xml:"text/xml",html:"text/html",json:"application/json"}[p]||"text/html",r.setRequestHeader("Accept",n+"; charset=utf-8"),r.send(null)}catch(e){}break;default:alert(i),r.send(null)}return!0},r.onerror=function(){l&&l.apply(null,arguments)},r.onabort=function(){u&&u.apply(null,arguments)},r.open(i,"GET"===i?t+(f?"?"+f:""):t,d),e.setTimeout(function(){v||(v=!0,r.abort())},g);try{return"responseXML"===h?r[h].childNodes[0]:r[h]}catch(e){}return!0}};return{get:function(e,t,o,r,i,c){return n.ajcall(e,{cback:t||function(){},method:"GET",async:!!o,data:r,cache:i,error:c})}}}(),EW.object=function(){function e(e,n){var t,o="";for(t in e)e.hasOwnProperty(t)&&(o+=n(e,t,o));return o}function n(e,n){return t(e)||"undefined"==typeof JSON?e==n:JSON.stringify(e)===JSON.stringify(n)}function t(e){return"object"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function o(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}function r(e,r,i,c){if(!e.match(/key|value|keyvalue/))throw new Error("Bad param for object.digFor");c=~~c;var a=0,s={key:function(e,t,o){return EW.object.isString(e)&&o instanceof RegExp?e.match(o):n(e,o)},value:function(e,t,o){return EW.object.isString(t)&&o instanceof RegExp?t.match(o):n(t,o)},keyvalue:function(e,t,o){return(EW.object.isString(e)&&o.key instanceof RegExp?e.match(o.key):n(e,o.key))&&(EW.object.isString(t)&&o.value instanceof RegExp?t.match(o.value):n(t,o.value))}}[e],l=[],u=function(e,n,t,o,r){var i=[].concat.call(e,[n]),c=s(n,o[n],t);c&&(l.push({obj:o,value:o[n],key:i[i.length-1],parentKey:i[i.length-2],path:i.join("/"),container:i.slice(0,i.length-1).join("/"),parentContainer:i.slice(0,i.length-2).join("/"),regexp:c,level:r}),a++),d(o[n],t,i,r+1)},d=function(e,n,r,i){if(!t(e)&&!o(e)){var s,l;if(e instanceof Array)for(s=0,l=e.length;s<l&&(u(r,s,n,e,i),!c||c!=a);s++);else{if("object"!=typeof e)return;for(s in e)if(u(r,s,n,e,i),c&&c==a)break}}};return d(r,i,[],0),l}return{toQs:function(n){return e(n,function(e,n,t){return((t?"&":"?")+encodeURIComponent(n)+"="+encodeURIComponent(e[n])).replace(/\'/g,"%27")})},jCompare:n,digForKey:function(e,n,t){return r("key",e,n,t)},digForValue:function(e,n,t){return r("value",e,n,t)},digForKeyValue:function(e,n,t){return r("value",e,n,t)},isString:function(e){return"string"==typeof e||e instanceof String},extend:function(e,n,t){var o,r=EW.object.clone(e);for(o in n)!n.hasOwnProperty(o)||o in r&&!t||(r[o]=n[o]);return r},clone:function(e){var n,t,o,r=EW.object;if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return n=new Date,n.setTime(e.getTime()),n;if(e instanceof Array){for(n=[],t=0,o=e.length;t<o;t++)n[t]=r.clone(e[t]);return n}if(e instanceof Object){n={};for(t in e)e.hasOwnProperty(t)&&(n[t]=r.clone(e[t]));return n}throw new Error("Unable to copy obj! Its type isn't supported.")}}}(),EW.Promise=function(){var e=function(){this.cbacks=[],this.solved=!1,this.result=null},n=e.prototype;return n.then=function(e,n){var t=this,o=function(){t.solved=!1,e.apply(n||t,[n||t,t.result])};return this.solved?o():this.cbacks.push(o),this},n.done=function(){var e=[].slice.call(arguments,0);if(this.result=e,this.solved=!0,!this.cbacks.length)return this.result;this.cbacks.shift()(e)},{create:function(){return new e}}}(),function(W){function Wnode(e,n,t){"use strict";var o=this,r=e.tag||"div";this.target=n,this.node=e.ns?document.createElementNS(e.ns,r):document.createElement(r),this.conf=e,this.root=t.root,this.parent=n,this.map=t.map,this.abort=t.abort,this.getNode=t.getNode,this.getNodes=t.getNodes,this.WIDGZARD_promise=__promise.create(),this.WIDGZARD_cb=e.cb||function(){__debug&&console.log("autoresolving  ",o.node),o.resolve()},this.WIDGZARD_promise.then(o.WIDGZARD_cb,o),this.WIDGZARD_len=e.content?e.content.length:0,this.done=this.resolve=this.solve=function(){0==--o.target.WIDGZARD_len&&(o.target.WIDGZARD_promise?o.target.WIDGZARD_promise.done():o.target.WIDGZARD_cb())},this.lateWid=t.lateWid}function cleanupWnode(e){var n=e.node,t=[],o=["WIDGZARD","WIDGZARD_cb","WIDGZARD_promise","WIDGZARD_length","parent","getNode","climb","root","done","resolve","data"],r=o.length,i=0,c=0,a=0,s=null;for(eulerWalk(n,function(e){e!==n&&3!=e.nodeType&&t.push(e)&&a++},"post");c<a;){for(s=t[c++];i<r;)s[o[i++]]=null;!function(e){e.parentNode.removeChild(e)}(s)}return t=null,o=null,!0}function render(e,n,t){var o,r,i=+new Date,c={node:e.target||document.body,endFunctions:[],childrens:[],reload:function(){render(e,!0)}},a={node:document.createDocumentFragment("div")},s=!0,l=c.node.innerHTML+"";if(__debug=!!e.debug,__autoclean&&c.WIDGZARD&&cleanupWnode(c),!e)throw new Exception("ERROR : Check parameters for render function");return r={root:c,map:{},getNode:function(e){return r.map[e]||!1},getNodes:function(){return r.map},abort:function(){return s=!1,c.node.innerHTML=l,"onAbort"in e&&(typeof e.onAbort).match(/function/i)&&e.onAbort.call(null,e),!1},lateWid:function(e){r.map[e]=this}},Wnode.prototype.setAttrs(c.node,e.attrs).setStyle(c.node,e.style).setData(c,e.data).setData(a,e.data),a.descendant=Wnode.prototype.descendant,n&&(c.node.innerHTML=""),void 0!==e.html&&(c.node.innerHTML=e.html),a.WIDGZARD_len=e.content?e.content.length:0,a.WIDGZARD_cb=c.WIDGZARD_cb=function(){if(s&&c.node.appendChild(a.node)&&e.cb&&e.cb.call(c),c.endFunctions.length)for(var n=0,t=c.endFunctions.length;n<t;n++)c.endFunctions[n]()},c.WIDGZARD=!0,c.getNode=r.getNode,c.getNodes=r.getNodes,c.abort=r.abort,c.map=r.map,c.report=function(){window.JSON&&console.log("json size : "+JSON.stringify(e).length),console.log("html size : "+c.node.innerHTML.length)},Wnode.prototype.checkInit(a,e),function e(n,t){if(!s)return!1;if(n.content)for(var o=0,i=n.content.length;o<i;o++)n.content[o]===__clearerClassName&&(n.content[o]={tag:"br",attrs:{class:__clearerClassName}}),"ns"in n&&(n.content[o].ns=n.ns),e(n.content[o],new Wnode(n.content[o],t,r).add())}(e,a),"content"in e||a.WIDGZARD_cb(),!t||t in __renders||(__renders[t]=c),o=+new Date,console.debug("Widgzard render time: "+(o-i)+"ms"),c}function get(e){var n=document.createElement("div");return e.target=n,render(e),n}function cleanup(e,n){render({target:e,content:[{html:n||""}]},!0)}function load(e){var n=document.createElement("script");document.getElementsByTagName("head")[0].appendChild(n),n.src=e,n.onload=function(){n.parentNode.removeChild(n)}}function eulerWalk(e,n,t){t={pre:"pre",post:"post"}[t]||"post";var o=function(){},r="pre"===t?n:o,i="post"===t?n:o;!function e(n,t){for(r(n),t=n.firstChild;t;)e(t),t=t.nextSibling;i(n)}(e)}function htmlspecialchars(e){return"<pre>"+e.replace(/&(?![\w\#]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")+"</pre>"}console.log("\n\n WIDGZARD v.0.2\n\n");var __clearerClassName="clearer",__nodeIdentifier="wid",__autoclean=!0,__debug=!1,__promise=EW.Promise,__renders={};Wnode.prototype.climb=function(e){e=e||1;for(var n=this;e--;)n=n.parent;return n},Wnode.prototype.descendant=function(){var e=this,n=Array.prototype.slice.call(arguments,0),t=0,o=e,r=n.length;if(!r)return o;for(;t<r;)o=o.childrens[~~n[t++]];return o},Wnode.prototype.setAttrs=function(e,n){if(void 0!==n)for(var t in n)"class"!==t?"style"!==t?e.setAttribute(t,n[t]):this.setStyle(e,n.style):e.className=n[t];return this},Wnode.prototype.setStyle=function(e,n){if(void 0!==n)for(var t in n)e.style[t.replace(/^float$/i,"cssFloat")]=n[t];return this},Wnode.prototype.setData=function(e,n){return e.data=n||{},this},Wnode.prototype.checkInit=function(e,n){return"init"in n&&"function"==typeof n.init&&!n.init.call(e)&&e.abort(),this},Wnode.prototype.checkEnd=function(e,n){return"end"in n&&"function"==typeof n.end&&this.root.endFunctions.push(function(){n.end.call(e)}),this},Wnode.prototype.add=function(){var conf=this.conf,node=this.node,tmp,i,j,k;return this.setAttrs(node,conf.attrs).setStyle(node,conf.style).setData(this,conf.data).checkInit(this,conf).checkEnd(this,conf),void 0!==conf.html&&(node.innerHTML=conf.html,(tmp=node.innerHTML.match(/2wdb\((.*)\)/))&&void 0!==(i=EW.checkNs(tmp[1],this))&&(j=("this."+tmp[1]).split("."),k=j.pop(),i=eval(j.join(".")),k in i&&EW.events.ww.on(i,k,node))),void 0!==conf.text&&(tmp=document.createTextNode(""+conf.text),node.appendChild(tmp)),void 0!==conf[__nodeIdentifier]&&(this.map[conf[__nodeIdentifier]]=this),(conf.target||this.target.node).appendChild(node),"childrens"in(conf.target||this.target)||((conf.target||this.target).childrens=[]),(conf.target||this.target).childrens.push(this),this.WIDGZARD=!0,(!conf.content||0==conf.content.length)&&this.WIDGZARD_cb.call(this),this},EW.Widgzard={render:render,cleanup:cleanup,get:get,load:load,htmlspecialchars:htmlspecialchars,getElement:function(e){return e in __renders&&__renders[e]},getElements:function(){return __renders},Promise:__promise}}(this),EW.makeNs("Engy",function(){function _configSet(e){var n;for(n in config)n in e&&(config[n]=e[n]);return this}function _overwrite(e,n,t){for(var o=n.split(/\.|\//),r=o.length,i=0;i<r-1;)e=e[o[i++]];e[o[r-1]]=t}function _mergeComponent(e,n,t){var o,r=EW.checkNs(n,e),i=t,c={},a=n.split(/\.|\//),o=0;a.length;for(o in i)c[o]=i[o];for(o in r)!o.match(/component|params/)&&(c[o]=r[o]);_overwrite(e,n,c)}function Processor(e){this.config=e,this.endPromise=EW.Promise.create()}function _process(e){return new Processor(e).run()}function _component(e,n){e in preloadedComponents||(preloadedComponents[Processor.prototype.getFileName(e)]=n)}function _components(e){for(var n in e)_component(n,e[n])}function _clone(e){if(null==e||"object"!=typeof e)return e;var n=e.constructor();for(var t in e)e.hasOwnProperty(t)&&(n[t]=_clone(e[t]));return n}function _define(e,n){}console.log("\n\n ENGY v.0.3\n\n");var components={},preloadedComponents={},config={fileNameSeparator:"/",fileNamePrepend:"",ext:".js",componentsUrl:"/components/"},num=0;return Processor.prototype.getFileName=function(e){var n=e.split(/\/|\|/),t=e,o=n.length;return n[o-1]=config.fileNamePrepend+n[o-1],t=n.join(config.fileNameSeparator),config.componentsUrl+(config.componentsUrl.match(/\/$/)?"":"/")+t+config.ext},Processor.prototype.run=function(){var self=this,langFunc=EW.i18n.parse,elementsN=0,countPromise=EW.Promise.create(),solveTime=EW.Promise.create(),start=+new Date,end,xhrTot=0,cback;return function solve(){var component=EW.object.digForKey(self.config,"component",1),componentName,cached,preLoaded,innerPromise=EW.Promise.create(),xhrStart=0,xhrEnd=0;innerPromise.then(solve),component.length?(elementsN++,component=component[0],componentName=self.getFileName(component.value),cached=componentName in components,preLoaded=componentName in preloadedComponents,cback=function(cntORobj){xhrEnd=+new Date,xhrTot+=xhrEnd-xhrStart;var params=EW.checkNs(component.container+"/params",self.config),obj,usedParams,foundParam,foundParamValue,foundParamValueReplaced,i,l;if(preLoaded?obj=_clone(cntORobj):(cached||(components[componentName]=_clone(cntORobj)),cntORobj=cntORobj.replace(/^[^{]*/,"").replace(/;?$/,""),obj=eval("("+cntORobj+")")),params&&(usedParams=EW.object.digForValue(obj,/#PARAM{([^}|]*)?\|?([^}]*)}/),l=usedParams.length))for(i=0;i<l;i++)foundParam=EW.checkNs(usedParams[i].regexp[1],params),foundParamValue=void 0!==foundParam?foundParam:usedParams[i].regexp[2]||"",(typeof foundParamValue).match(/string/i)?(foundParamValueReplaced=EW.checkNs(usedParams[i].path,obj).replace(usedParams[i].regexp[0],foundParamValue),_overwrite(obj,usedParams[i].path,foundParamValueReplaced)):_overwrite(obj,usedParams[i].path,foundParamValue);component.container?_mergeComponent(self.config,component.container,obj):self.config=obj,innerPromise.done()},xhrStart=+new Date,preLoaded?cback(preloadedComponents[componentName]):cached?cback(components[componentName]):EW.io.get(componentName,cback,!0)):(end=+new Date,self.endPromise.done(self.config),countPromise.done(elementsN),solveTime.done(end-start))}(),langFunc&&langFunc(self.config),countPromise.then(function(e,n){console.log("Engy used "+n[0]+" component"+(1==n[0]?"":"s"))}),solveTime.then(function(e,n){console.log("Engy total time: "+n[0]+"ms"),console.log('      "       unfolding : '+(n[0]-xhrTot)+"ms"),console.log('      "       xhr : '+xhrTot+"ms")}),self.endPromise},{configSet:_configSet,process:_process,component:_component,components:_components,get:function(e,n,t){var o=EW.Promise.create();return _process(e).then(function(e,n){o.done(EW.Widgzard.get(n[0]))}),o},load:function(e){return EW.Widgzard.load(e)},define:_define,getElement:function(e){return EW.Widgzard.getElement(e)},getElements:function(){return EW.Widgzard.getElements()},render:function(e,n,t){var o=+new Date,r=EW.Promise.create();return _process(e).then(function(e,i){console.log("t: "+(+new Date-o)),r.done(EW.Widgzard.render(i[0],n,t))}),r}}},EW)}();